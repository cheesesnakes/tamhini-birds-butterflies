---
title: "Shifts in bird and butterfly communities of Tamhini Ghat"
output:
  html_document:
    css: style.css
    df_print: kable
    theme: spacelab
    toc: yes
    toc_float: yes
    toc_depth: 2
    number_sections: yes
subtitle: Analysis for manuscript
Author: Shawn Dsouza
---


# Introduction

This file was last update on `r Sys.Date()`

```{r setup, include=FALSE, message=FALSE, warning=FALSE}

options(max.print="75")

knitr::opts_chunk$set(echo = FALSE, error = T, warning = F, message = F, tidy = T, 
                      cache = T, dpi = 300, fig.align = "center", fig.height = 4.5, fig.width = 8)

#Required libraries

library(tidyverse)
library(broom)
library(lubridate)
library(viridis)
library(RColorBrewer)

#Data import

abn <- read.csv("./Data/Abundance_280820.csv")
transects <- read.csv("./Data/Transects.csv")

# adding relevant variables

abn <- abn%>%
  mutate(Year = year(dmy(Date)))%>% #adding year of sampling
  mutate(Study = case_when(Year %in% c(1998, 1999, 2000, 2001) ~ "1998 - 2000", #previous study
                           Year %in% c(2016, 2017) ~ "2016 - 2017"))%>% #current study
  mutate(Transect = as.character(Transect),
         Transect = ifelse(Transect == "T6A" | Transect == "T6B", "T6", Transect),
         Transect = as.factor(Transect))

transects <- transects%>%
  mutate(Transect = as.factor(Transect))

# cleaning abundance
abn <- abn%>%
  filter(!is.na(Abundance) &
         Specific.Epithet != "" & #removing samples with no species
         Specific.Epithet != " " &
          Specific.Epithet != "Unidentified" & #removing unidentified species
         substr(Specific.Epithet, 1, 1) != "?")%>% #83 obs removed
  droplevels()

theme_set(theme_bw()+
            theme(legend.position = "top",
                  text = element_text(size = 20)
                  )
          )#setting ggplot theme

# function for t-test reporting

tstats <- function(x){
  x%>%
    rename('1998-2001' = estimate1,
         '2016-2017' = estimate2)%>%
    dplyr::select(`1998-2001`, `2016-2017`, parameter, statistic, p.value)
}

```

# Sampling effort

No. of visits to each transect/site.

```{r}
abn%>%
  group_by(Study, Taxa, Transect)%>%
  summarise(n = length(unique(Date)))%>%
  spread(Transect, n)
```

Uneveness in sampling effort across sites in studies may bias estimates of change.

# Change in diversity across years

## Species richness

### Across the two studies

```{r}
abn%>%
  group_by(Taxa, Study)%>%
  summarise(richness = length(unique(Specific.Epithet)),
            N = sum(Abundance, na.rm = T))
```

More species of both taxa were encountered in current study compared to the previous study. Difference in sampling effort is apparent accross two studies.

### Across sites in the two studies

No. of species encountered across sites sampled in the two studies.

```{r}
abn%>%
  left_join(transects, by = c("Transect"))%>%
  group_by(Taxa, Study, Transect)%>%
  summarise(richness = length(unique(Specific.Epithet)))%>%
  spread(Transect, richness)
```

Fewer species were encountered in sites with lower effort in the previous study, i.e., T5 and T6. 

## Shannon diversity

```{r fig.height=6}

# Calculating diversity in each site over years

div_year <- abn%>%
  group_by(Study, Taxa, Transect,  Specific.Epithet)%>%
  summarise(n = sum(Abundance, na.rm = T))%>%
  spread(Specific.Epithet, n, fill = c(0))%>%
  group_by(Study, Taxa, Transect)%>%
  nest()%>%
  mutate(H = map_dbl(data, ~vegetarian::d(.[-1], lev = "alpha", q = 1)))%>%
  dplyr::select(-data)

# Summary

div_year%>%
  group_by(Taxa, Study)%>%
  skimr::skim(H)%>%
  skimr::yank("numeric")%>%
  dplyr::select(Taxa, Study, mean, sd)

# t test

div_year%>%
  group_by(Taxa)%>%
  nest()%>%
  mutate(test = map(data, ~t.test(H ~ Study, data = .)),
         sumry = map(test, broom::tidy))%>%
  dplyr::select(sumry)%>%
  unnest()%>%
  tstats()
  
  
# plot

div_year%>%
  ggplot(aes(Taxa, H, col = Study, fill = Study))+
  geom_boxplot(width = 0.25, alpha = 0.5)+
  labs(y = "Effective number of species")+
  scale_color_brewer(palette = "Set1")
  
```

The first order diversity of both taxa has increased *significantly* across the two surveys.

# Change in composition of species accross years

```{r results=F, fig.height=8}
library(vegan)

# input for vegan

veg_birds <- abn%>%
  filter(Taxa == "Birds")%>%
  group_by(Study, Transect, Specific.Epithet)%>%
  summarise(n = sum(Abundance, na.rm = T))%>%
  mutate(sample = paste(Study, "_", Transect))%>%
  group_by(sample)%>%
  #mutate(N = sum(n, na.rm = T))%>%
  #filter(N > 0)%>%#removing samples where no species were detected
  dplyr::select(sample, Specific.Epithet, n)%>%
  ungroup()%>%
  spread(Specific.Epithet, n, fill = c(n = 0))%>%
  column_to_rownames(var = "sample")

veg_butterfly <- abn%>%
  filter(Taxa == "Butterflies")%>%
  group_by(Study, Transect, Specific.Epithet)%>%
  summarise(n = sum(Abundance, na.rm = T))%>%
  mutate(sample = paste(Study, "_", Transect))%>%
  group_by(sample)%>%
  #mutate(N = sum(n, na.rm = T))%>%
  #filter(N > 0)%>%#removing samples where no species were detected
  dplyr::select(sample, Specific.Epithet, n)%>%
  ungroup()%>%
  spread(Specific.Epithet, n, fill = c(n = 0))%>%
  column_to_rownames(var = "sample")

# sample info

samp_birds <- abn%>%
  left_join(transects, by = c("Transect"))%>%
  filter(Taxa == "Birds")%>%
  dplyr::select(Study, Taxa, Transect, Habitat)%>%
  distinct()%>%
  mutate(sample = paste(Study, "_", Transect))

samp_butterfly <- abn%>%
  left_join(transects, by = c("Transect"))%>%
  filter(Taxa == "Butterflies")%>%
  dplyr::select(Study, Taxa, Transect, Habitat)%>%
  distinct()%>%
  mutate(sample = paste(Study, "_", Transect))
```

```{r}
# Similarity matrix by studies

sim_birds <- abn%>%
  filter(Taxa == "Birds")%>%
  group_by(Study, Specific.Epithet)%>%
  summarise(n = sum(Abundance, na.rm = T))%>%
  mutate(sample = Study)%>%
  ungroup()%>%
  dplyr::select(sample, Specific.Epithet, n)%>%
  spread(Specific.Epithet, n, fill = c(n = 0))%>%
  column_to_rownames(var = "sample")

sim_butterfly <- abn%>%
  filter(Taxa == "Butterflies")%>%
  group_by(Study, Specific.Epithet)%>%
  summarise(n = sum(Abundance, na.rm = T))%>%
  mutate(sample = Study)%>%
  ungroup()%>%
  dplyr::select(sample, Specific.Epithet, n)%>%
  spread(Specific.Epithet, n, fill = c(n = 0))%>%
  column_to_rownames(var = "sample")

# bray - curtis

data_frame(
  Taxa = c("Birds", "Butterflies"),
  Dissimilarity = c(as.numeric(vegdist(sim_birds, method = "bray")),
                    as.numeric(vegdist(sim_butterfly, method = "bray")))
)

```

```{r results=F, fig.height=8}
# ordination

NMDS_birds <- metaMDS(veg_birds, distance = "bray", k = 2, model = "local")

NMDS_butterfly <- metaMDS(veg_butterfly, distance = "bray", trymax = 1000, k = 2, model = "local")


# Extracting scores and adding habitat vars

ord_birds <- data.frame(scores(NMDS_birds))%>%
  rownames_to_column("sample")%>%
  left_join(samp_birds, "sample")

ord_butterfly <- data.frame(scores(NMDS_butterfly))%>%
  rownames_to_column("sample")%>%
  left_join(samp_butterfly, "sample")

ord <- bind_rows(ord_birds, ord_butterfly)

```

```{r}
#Testing change in composition of birds

adonis(veg_birds ~ Study, data = samp_birds)
```

```{r}
#Testing change in composition of butterflies

adonis(veg_butterfly ~ Study, data = samp_butterfly)
```

```{r fig.height=6}
# plotting

ord%>%
  ggplot(aes(NMDS1, NMDS2, col = Study, fill = Study))+
  stat_ellipse(level = 0.95, geom = "polygon", linetype = "dashed", size = 1, alpha = 0.3)+
  geom_point(aes(shape = Habitat), size = 3)+
  guides(shape = guide_legend(nrow = 2, byrow = T))+
  scale_color_brewer(palette = "Set1")+
  facet_wrap(~Taxa)+
  theme(legend.box = "vertical")

```

Both bird and butterfly communities compositions are *significantly* different compared to the previous study.

# Change in niche width of community

## Trophic Guilds

```{r fig.height=8}
# compiling trophic guild data

host <- read.csv("./Data/Butterflies_host plant_280820.csv") #butterfly host plant data

diet <- read.csv("./Data/Birds_diet.csv") #bird diet data

trophic <- host%>%
  full_join(diet)%>%
  dplyr::select(Specific.Epithet, Guild)%>%
  distinct()

# Calculating relative proportion of guilds

guilds <- abn%>%
  left_join(trophic, by = c("Specific.Epithet"))%>%
  group_by(Study, Taxa, Transect,  Guild)%>%
  summarise(n = sum(Abundance, na.rm = T))%>%
  #group_by(Study, Taxa, Transect)%>%
  mutate(N = sum(n))%>%
  #filter(Guild == "Generalist" | Guild == "Omnivore")%>%
  mutate(prop.gen = n/N)%>%
  filter(Guild != "",
         !is.na(Guild))
# summary

guilds%>%
  group_by(Taxa, Guild, Study)%>%
  skimr::skim(prop.gen)%>%
  skimr::yank("numeric")%>%
  dplyr::select(Taxa, Guild, Study, mean, sd)

# t - test

guilds%>%
  filter(Guild != "Liana Specialist")%>% #removing due to lack of obs
  complete(nesting(Study, Taxa), Transect, Guild, fill = list(prop.gen = 0))%>%
  group_by(Taxa, Guild)%>%
  nest()%>%
  mutate(test = map(data, ~t.test(prop.gen ~ Study, data = .)),
         sumry = map(test, broom::tidy))%>%
  dplyr::select(sumry)%>%
  unnest()%>%
  tstats()

# plot
guilds%>%
  ggplot(aes(reorder(Guild, prop.gen), prop.gen, col = Study, fill = Study))+
  geom_boxplot(width = 0.25, alpha = 0.5, position = position_dodge(preserve = "single"))+
  labs(y = "Relative Proportion", x = "Trophic Guild")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  scale_color_brewer(palette = "Set1")+
  facet_wrap(~Taxa, scales = "free_x", ncol = 1)
  
```
Carnivorous, Grainivorous birds have reduced in the comunity, compared to insectivorous birds which have increased. Similarly, Shrub specialist and tree specialist butterflies have reduced where grass specialists and herb specialist have increased. Suprsingly, generalist species of both taxa appear to be unchanged.

# Change in niche specialisation

-Can we incorporate abunndance into community specialisation index?

## Trophic niche

```{r}
# trophic specialisation based on Juliard et al. 2006

butterflies_TSI <- host%>%
  mutate(H = length(unique(Hostplant.Family)))%>%
  group_by(Specific.Epithet)%>%
  mutate(h = length(unique(Hostplant.Family)))%>%
  ungroup()%>%
  mutate(TSI = sqrt((H/h)-1))

birds_TSI <- diet%>%
  mutate(H = length(unique(Prey)))%>%
  group_by(Specific.Epithet)%>%
  mutate(h = length(unique(Prey)))%>%
  ungroup()%>%
  mutate(TSI = sqrt((H/h)-1))

CSI.T <- abn%>%
  dplyr::select(Study, Transect, Taxa, Specific.Epithet)%>%
  group_by(Study, Taxa, Transect)%>%
  distinct()%>%
  left_join(butterflies_TSI, by = c("Specific.Epithet"))%>%
  left_join(birds_TSI, by = c("Specific.Epithet"))%>%
  mutate(TSI = ifelse(is.na(TSI.x), TSI.y, TSI.x))%>%
  dplyr::select(Study, Transect, Taxa, Specific.Epithet, TSI)%>%
  summarise(CSI.T = mean(TSI, na.rm = T))
```

```{r}
# summary
CSI.T%>%
  group_by(Taxa, Study)%>%
  skimr::skim(CSI.T)%>%
  skimr::yank("numeric")%>%
  dplyr::select(Taxa, Study, mean, sd)
```

```{r}
# t - test

CSI.T%>%
  group_by(Taxa)%>%
  nest()%>%
  mutate(test = map(data, ~t.test(CSI.T ~ Study, data = .)),
         sumry = map(test, broom::tidy))%>%
  dplyr::select(sumry)%>%
  unnest()%>%
  tstats()
```

```{r}
fig4b <- CSI.T%>%
  ggplot(aes(Taxa, CSI.T, col = Study, fill = Study))+
  geom_boxplot(width = 0.25, alpha = 0.5)+
  labs(y = "Community specialisation index \n (Trophic)")+
  scale_color_brewer(palette = "Set1")+
  scale_y_sqrt()

fig4b
```

Niche width of the community did not change over the two studies.

## Habitat Niche

```{r}
HSI <- abn%>%
  left_join(transects, by = c("Transect"))%>%
  group_by(Study, Taxa, Habitat, Specific.Epithet)%>%
  # calculating abundance of each species in each habitat type
  summarise(n = sum(Abundance, na.rm = T))%>%
  group_by(Study, Taxa)%>%
  mutate(N = sum(n), # total number of indviduals encountered 
         rel.prop = n/N)%>% # relative proportion of species
  group_by(Study, Specific.Epithet)%>%
  summarise(HSI = sd(rel.prop)/mean(rel.prop))%>%
  replace_na(replace = list(HSI = 0))

CSI.H <- abn%>%
  dplyr::select(Study, Transect, Taxa, Specific.Epithet)%>%
  group_by(Study, Taxa, Transect)%>%
  distinct()%>%
  left_join(HSI, by = c("Study", "Specific.Epithet"))%>%
  dplyr::select(Study, Transect, Taxa, Specific.Epithet, HSI)%>%
  summarise(CSI.H = mean(HSI, na.rm = T))
```

```{r}
# summary
CSI.H%>%
  group_by(Taxa, Study)%>%
  skimr::skim(CSI.H)%>%
  skimr::yank("numeric")%>%
  dplyr::select(Taxa, Study, mean, sd)
```

```{r}
# t - test

CSI.H%>%
  group_by(Taxa)%>%
  nest()%>%
  mutate(test = map(data, ~t.test(CSI.H ~ Study, data = .)),
         sumry = map(test, broom::tidy))%>%
  dplyr::select(sumry)%>%
  unnest()%>%
  tstats()
```

```{r fig.height=6}
fig4a <- CSI.H%>%
  ggplot(aes(Taxa, CSI.H, col = Study, fill = Study))+
  geom_boxplot(width = 0.25, alpha = 0.5)+
  labs(y = "Community specialisation index \n (Habitat)")+
  scale_color_brewer(palette = "Set1")

fig4a
```

Habitat niche of the community did not change over the study periods.

# Seasonal changes in relative abundance

```{r fig.height=6}
season <- abn%>%
  mutate(Month = month(dmy(Date), label = T))%>%
  group_by(Study, Month, Taxa)%>%
  summarise(n = sum(Abundance, na.rm=T))%>%
  group_by(Study, Taxa)%>%
  mutate(N = sum(n),
         rel.prop = n/N)

season%>%
  ggplot(aes(Month, rel.prop, col = Taxa, shape = Taxa))+
  geom_point(size = 3)+
  geom_path(aes(group = Taxa), size = 1, linetype = "dashed")+
  scale_color_brewer(palette = "Set1")+
  facet_wrap(~Study, ncol = 1)
```

# Site Map

```{r fig.height=8}
library(raster)
library(sf)

sites <- read.csv("./Data/sites.csv")%>%
  drop_na()

sites_sf <- st_as_sf(sites, coords = c('Lat', 'Lon'))

area <- extent(sites_sf)

plot(area)

sites%>%
  ggplot(aes(Lat, Lon, group = Transect))+
  geom_point()+
  geom_line()+
  geom_label(aes(label = Transect))
```

